<%- include('../partials/user/header') %>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<style>
    .card-green {
      background-color: #ADD8E6;
    }
    .main {
      padding: 30px 0;
    }
   
   
    .dashboard-menu {
      background-color: #cce3e6;
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }
   
   
    .dashboard-menu .nav-link {
    font-weight: bold;
    color: #30683c;
    box-shadow: 0 4px 10px rgba(123, 131, 112, 0.3), 0 4px 20px rgba(0, 191, 255, 0.2);
    transition: box-shadow 0.3s ease;
   }
   
   
   .dashboard-menu .nav-link:hover {
    color: #00bfff;
    box-shadow: 0 4px 15px rgba(173, 255, 47, 0.5), 0 6px 25px rgba(0, 191, 255, 0.4);
   }
   
   
    .card {
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
      margin-bottom: 20px;
    }
   
   
    .card-header {
      background-color: #487379;
      color: white;
      border-radius: 10px 10px 0 0;
    }
   
   
    .btn-success {
      background-color: #577194;
      border-color: #6bb87d;
    }
   
   
    .btn-success:hover {
      background-color: #506955;
    }
   
   
    .form-group {
      margin-bottom: 15px;
    }
   
   
    .required {
      color: red;
    }
   
   
     @media (max-width: 768px) {
      .dashboard-menu {
        padding: 10px;
      }
   
   
      .card {
        margin-bottom: 15px;
      }
    }
    .page-header.breadcrumb-wrap {
    background-color: #eee2e9;
    padding: 15px 0;
   }
   
   
   .breadcrumb {
    display: flex;
    align-items: center;
    font-family: 'Arial', sans-serif;
    font-size: 16px;
    color: #121311;
   }
   
   
   .breadcrumb a {
    color: #007bff;
    text-decoration: none;
    position: relative;
    margin: 0 5px;
   }
   
   
   .breadcrumb a:hover {
    color: #0056b3;
   }
   
   
   .breadcrumb span {
    margin: 0 5px;
    color: #999;
   }
   
   
   .breadcrumb a::after {
    content: '';
    position: absolute;
    width: 100%;
    height: 2px;
    background: #6e6e3a;
    left: 0;
    bottom: -2px;
    transform: scaleX(0);
    transition: transform 0.3s ease;
   }
   
   
   .breadcrumb a:hover::after {
    transform: scaleX(1);
   }



   
   </style>

<main class="main">
    <div class="page-header breadcrumb-wrap">
        <div class="container">
            <div class="breadcrumb">
                <a href="/" rel="nofollow">Home</a>
                <span></span> Wallet
            </div>
        </div>
    </div>
    <section class="mt-50 mb-50">
        <div class="container">
            <div class="row">
                
                <div class="col-md-3 order-1 order-md-1">
                    <div class="dashboard-menu">
                        <ul class="nav flex-column" role="tablist">
                            <li class="nav-item">
                                <a class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" href="#dashboard" role="tab" aria-controls="dashboard" aria-selected="false">
                                  <i class="fi-rs-settings-sliders mr-10"></i>Dashboard
                                </a>
                              </li>
                              <li class="nav-item">
                                <a class="nav-link" id="address-tab" data-bs-toggle="tab" href="#address" role="tab" aria-controls="address" aria-selected="false">
                                  <i class="fi-rs-marker mr-10"></i>My Address
                                </a>
                              </li>
                            <li class="nav-item">
                                <a class="nav-link" id="orders-tab" href="/order-history" aria-selected="false">
                                    <i class="fi-rs-shopping-bag mr-10"></i>Orders
                                </a>
                            </li>

                            <li class="nav-item">
                                <a class="nav-link" id="track-orders-tab"  href="/wishlist"  aria-selected="false">
                                  <i class="fa fa-heart mr-10"></i> Wishlist
                                </a>
                              </li>
                              
                            <li class="nav-item">
                                <a class="nav-link" id="track-orders-tab" href="/wallet" aria-selected="false">
                                    <i class="fi-rs-shopping-cart-check mr-10"></i>Wallet
                                </a>
                            </li>
                          
                            <li class="nav-item">
                                <a class="nav-link" id="track-orders-tab"  href="/referals"  aria-selected="false">
                                    <i class="fi-rs-shopping-cart-check mr-10"></i>Referals
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="/logout">
                                    <i class="fi-rs-sign-out mr-10"></i>Logout
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>

                <div class="col-md-9 order-2 order-md-2">
                    <div class="table-responsive">
                        <table class="table shopping-summery text-center">
                            <thead>
                                <tr class="main-heading">
                                    <th scope="col">Wallet Balance</th>
                                    <th scope="col">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="balance" data-title="Balance">
                                        <strong style="font-size: 40px;">₹<%=balance.toLocaleString()%></strong>
                                    </td>
                                    <td data-title="Actions">
                                        <button onclick="showAddMoneyForm()" class="btn btn-primary">Add Money</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Add Money Form -->
                    <div id="addMoneyForm" class="mt-4" style="display: none;">
                        <div class="form-group">
                            <label for="amount">Enter Amount to Add</label>
                            <input type="number" id="amount" class="form-control" placeholder="Enter amount" min="1">
                        </div>
                        <button onclick="confirmAddMoney()" class="btn btn-success">Confirm Add Money</button>
                    </div>

                    <div class="table-responsive mt-4">
                        <table class="table shopping-summery text-center">
                            <thead>
                                <tr class="main-heading">
                                    <th scope="col">Date</th>
                                    <th scope="col">Transaction Type</th>
                                    <th scope="col">Amount</th>
                                    <th scope="col">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% for (let i = transactions.length - 1; i >= 0; i--) { %>
                                    <tr>
                                        <td data-title="Date"><%=transactions[i].date.toLocaleDateString()%></td>
                                        <td data-title="Transaction Type"><%=transactions[i].type%></td>
                                        <% if (transactions[i].type === "Purchase") { %>
                                            <td data-title="Amount">
                                                <b class="text-danger" style="font-size: 25px;">-</b>&nbsp;
                                                <strong class="text-danger">₹<%=transactions[i].amount.toLocaleString()%></strong>
                                            </td>
                                        <% } else if (transactions[i].type === "Refund") { %>
                                            <td data-title="Amount">
                                                <b class="text-success" style="font-size: 20px;">+</b>&nbsp;
                                                <strong class="text-success">₹<%=transactions[i].amount.toLocaleString()%></strong>
                                                <small class="text-muted">(Refund)</small>
                                            </td>
                                        <% } else { %>
                                            <td data-title="Amount">
                                                <b class="text-success" style="font-size: 20px;">+</b>&nbsp;
                                                <strong class="text-success">₹<%=transactions[i].amount.toLocaleString()%></strong>
                                            </td>
                                        <% } %>
                                        <td data-title="Status">
                                            <% if (transactions[i].status === "Refunded" || transactions[i].status === "Completed") { %>
                                                <span class="text-success font-weight-bold"><%=transactions[i].status%></span>
                                            <% } else if (transactions[i].status === "Failed") { %>
                                                <span class="text-danger font-weight-bold"><%=transactions[i].status%></span>
                                            <% } else { %>
                                                <span class="text-warning font-weight-bold"><%=transactions[i].status%></span>
                                            <% } %>
                                        </td>
                                    </tr>
                                <% } %>
                                <% if (transactions.length === 0) { %>
                                    <tr>
                                        <td colspan="4">No transactions available</td>
                                    </tr>
                                <% } %>
                            </tbody>
                        </table>
                        <div class="pagination justify-content-center mt-4">
                            <nav>
                                <ul class="pagination">
                                    <% if (currentPage > 1) { %>
                                        <li class="page-item">
                                            <a class="page-link" href="?page=<%= currentPage - 1 %>&limit=<%= limit %>">Previous</a>
                                        </li>
                                    <% } else { %>
                                        <li class="page-item disabled">
                                            <a class="page-link">Previous</a>
                                        </li>
                                    <% } %>
                        
                                    <% for (let i = 1; i <= totalPages; i++) { %>
                                        <li class="page-item <%= i === currentPage ? 'active' : '' %>">
                                            <a class="page-link" href="?page=<%= i %>&limit=<%= limit %>"><%= i %></a>
                                        </li>
                                    <% } %>
                        
                                    <% if (currentPage < totalPages) { %>
                                        <li class="page-item">
                                            <a class="page-link" href="?page=<%= currentPage + 1 %>&limit=<%= limit %>">Next</a>
                                        </li>
                                    <% } else { %>
                                        <li class="page-item disabled">
                                            <a class="page-link">Next</a>
                                        </li>
                                    <% } %>
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</main>
<%- include('../partials/user/footer') %>

<script>

function initiateAddMoney(amount) {
   
    Swal.fire({
        title: 'Processing...',
        text: 'Please wait while we process your request',
        allowOutsideClick: false,
        didOpen: () => {
            Swal.showLoading();
        }
    });

    fetch('/create-wallet', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ amount: parseFloat(amount) })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        Swal.close();
        
        const options = {
            key: data.keyId, 
            amount: data.amount,
            currency: "INR",
            name: "FIOREA",
            description: "Wallet Top Up",
            order_id: data.orderId,
            handler: function (response) {
                
                Swal.fire({
                    title: 'Verifying Payment...',
                    text: 'Please wait while we verify your payment',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                fetch('/verify-wallet', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        paymentId: response.razorpay_payment_id,
                        orderId: response.razorpay_order_id,
                        signature: response.razorpay_signature,
                        amount: amount 
                    })
                })
                .then(res => {
                    if (!res.ok) {
                        throw new Error('Payment verification failed');
                    }
                    return res.json();
                })
                .then(result => {
                    if (result.success) {
                        Swal.fire({
                            title: 'Success!',
                            text: 'Your wallet has been topped up successfully.',
                            icon: 'success'
                        }).then(() => {
                            window.location.reload();
                        });
                    } else {
                        throw new Error(result.message || 'Payment verification failed');
                    }
                })
                .catch(error => {
                    Swal.fire({
                        title: 'Error!',
                        text: error.message || 'Something went wrong during payment verification.',
                        icon: 'error'
                    });
                });
            },
            prefill: {
                name: 'User Name',
                email: 'user@example.com',
                contact: '1234567890'
            },
            theme: {
                color: "#3399cc"
            },
            modal: {
                ondismiss: function() {
                    Swal.fire({
                        title: 'Payment Cancelled',
                        text: 'Your payment process was cancelled.',
                        icon: 'info'
                    });
                }
            }
        };

        const rzp1 = new Razorpay(options);
        rzp1.open();
    })
    .catch(error => {
        Swal.fire({
            title: 'Error!',
            text: error.message || 'Something went wrong while initiating payment.',
            icon: 'error'
        });
    });
}

function showAddMoneyForm() {
    const form = document.getElementById('addMoneyForm');
    if (form.style.display === 'block') {
        form.style.display = 'none';
    } else {
        form.style.display = 'block';
    }
}

function confirmAddMoney() {
    const amountInput = document.getElementById('amount');
    const amount = parseFloat(amountInput.value);

    if (!amount || isNaN(amount) || amount <= 0) {
        Swal.fire({
            title: "Invalid Amount",
            text: "Please enter a valid amount greater than 0.",
            icon: "error"
        });
        return;
    }

    if (amount > 50000) { 
        Swal.fire({
            title: "Amount Too High",
            text: "Maximum amount allowed is ₹50,000 per transaction.",
            icon: "warning"
        });
        return;
    }

    Swal.fire({
        title: "Add Money",
        text: `Do you want to add ₹${amount.toFixed(2)} to your wallet?`,
        icon: "info",
        showCancelButton: true,
        confirmButtonColor: "#3085d6",
        cancelButtonColor: "#d33",
        confirmButtonText: "Yes, add money!"
    }).then((result) => {
        if (result.isConfirmed) {
            initiateAddMoney(amount);
        }
    });
}

    
</script>